name: Deploy mdBook site to Pages

on:
    push:
        branches:
            - "*" # Runs on all branches
    workflow_dispatch: # Allows manual triggering

permissions:
    contents: read
    id-token: write
    pages: write
    packages: read # Needed to pull from GHCR

concurrency:
    group: pages
    cancel-in-progress: false

jobs:
    deploy:
        runs-on: ubuntu-latest
        container:
            image: ghcr.io/${{ github.repository_owner }}/mdbook:latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v4
              with:
                  submodules: true
                  fetch-depth: 0

            - name: Install dependencies
              run: |
                  apk add --no-cache curl

            - name: Prepare assets directories
              run: |
                  mkdir -p src/fonts src/assets

            - name: Download additional assets
              run: |
                  # Devicon Fonts and CSS
                  curl -sSf -o devicon.min.css https://raw.githubusercontent.com/devicons/devicon/master/devicon.min.css
                  curl -sSf -o src/fonts/devicon.eot https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.eot
                  curl -sSf -o src/fonts/devicon.svg https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.svg
                  curl -sSf -o src/fonts/devicon.ttf https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.ttf
                  curl -sSf -o src/fonts/devicon.woff https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.woff

                  # WhichLang Assets
                  curl -sSf -o src/assets/whichlang.css https://raw.githubusercontent.com/phoenixr-codes/mdbook-whichlang/master/src/whichlang.css
                  curl -sSf -o src/assets/whichlang.js https://raw.githubusercontent.com/phoenixr-codes/mdbook-whichlang/master/dist/whichlang.js

            - name: Build the mdBook site
              run: mdbook build

            - name: Turn off Jekyll
              run: touch book/.nojekyll

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v2
              with:
                  path: ./book

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v3
              if: ${{ github.ref == 'refs/heads/main' }}
