name: Deploy mdBook Site to Pages

on:
  push:
    branches:
      - "*"
  workflow_dispatch:

env:
  SCCACHE_VERSION: "0.9.0"
  MDBOOK_VERSION: "0.4.43"
  MDBOOK_ADMONISH_VERSION: "1.15.0"
  MDBOOK_GRAPHVIZ_VERSION: "0.1.6"
  MDBOOK_MERMAID_VERSION: "0.13.0"

permissions:
  contents: read
  id-token: write
  pages: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build-deps:
    runs-on: ubuntu-24.04
    steps:
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2.7.5

      - name: Build mdbook-footnote
        run: cargo install mdbook-footnote

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: mdbook-footnote
          path: ~/.cargo/bin/mdbook-footnote
          retention-days: 1

  deploy-mdbook:
    needs: build-deps
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Install mdBook
        run: |
          wget -qO mdbook.tar.gz \
            "https://github.com/rust-lang/mdBook/releases/download/v${MDBOOK_VERSION}/mdbook-v${MDBOOK_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          sudo tar xf mdbook.tar.gz -C /usr/local/bin
          rm -rf mdbook.tar.gz

      - name: Install mdbook-admonish
        run: |
          wget -qO admonish.tar.gz \
            "https://github.com/tommilligan/mdbook-admonish/releases/download/v${MDBOOK_ADMONISH_VERSION}/mdbook-admonish-v${MDBOOK_ADMONISH_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          sudo tar xf admonish.tar.gz -C /usr/local/bin
          rm -rf admonish.tar.gz

      - name: Download mdbook-footnote
        uses: actions/download-artifact@v4
        with:
          name: mdbook-footnote
          path: /usr/local/bin

      - name: Make footnote executable
        run: sudo chmod +x /usr/local/bin/mdbook-footnote

      - name: Install mdbook-graphviz
        run: |
          wget -qO graphviz.zip \
            "https://github.com/dylanowen/mdbook-graphviz/releases/download/v${MDBOOK_GRAPHVIZ_VERSION}/mdbook-graphviz_v${MDBOOK_GRAPHVIZ_VERSION}_x86_64-unknown-linux-musl.zip"
          unzip -o graphviz.zip -d /usr/local/bin
          sudo chmod +x /usr/local/bin/mdbook-graphviz
          rm -rf graphviz.zip

      - name: Install mdbook-mermaid
        run: |
          wget -qO mermaid.tar.gz \
            "https://github.com/badboy/mdbook-mermaid/releases/download/v${MDBOOK_MERMAID_VERSION}/mdbook-mermaid-v${MDBOOK_MERMAID_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          sudo tar xf mermaid.tar.gz -C /usr/local/bin
          rm -rf mermaid.tar.gz

      - name: Prepare Assets Directories
        run: mkdir -p src/fonts src/assets theme

      - name: Setup Catppuccin Theme
        run: |
          # Download latest Catppuccin theme
          curl -sSfL -o theme/catppuccin.css \
            https://github.com/catppuccin/mdBook/releases/latest/download/catppuccin.css
          # Keep only index.hbs from default theme
          mdbook init --theme .
          find ./theme -type f ! -name 'index.hbs' -delete
          rm -d fonts css || true
          # Update index.hbs theme options
          sed -i 's/Light/Latte/; s/Rust/Frapp√©/; s/Coal/Macchiato/; s/Navy/Mocha/; /Ayu/d' theme/index.hbs

      - name: Download Additional Assets
        run: |
          # Devicon Fonts and CSS
          curl -sSf \
            -o devicon.min.css \
            https://raw.githubusercontent.com/devicons/devicon/master/devicon.min.css
          curl -sSf \
            -o src/fonts/devicon.eot \
            https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.eot
          curl -sSf \
            -o src/fonts/devicon.svg \
            https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.svg
          curl -sSf \
            -o src/fonts/devicon.ttf \
            https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.ttf
          curl -sSf \
            -o src/fonts/devicon.woff \
            https://raw.githubusercontent.com/devicons/devicon/master/fonts/devicon.woff

          # WhichLang Assets
          curl -sSf \
            -o src/assets/whichlang.css \
            https://raw.githubusercontent.com/phoenixr-codes/mdbook-whichlang/master/src/whichlang.css
          curl -sSf \
            -o src/assets/whichlang.js \
            https://raw.githubusercontent.com/phoenixr-codes/mdbook-whichlang/master/dist/whichlang.js

      - name: Build the mdBook Site
        run: mdbook build

      - name: Turn off Jekyll
        run: touch book/.nojekyll

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        if: ${{ github.ref == 'refs/heads/main' }}
